use std::collections::{HashMap, HashSet, VecDeque};

const INPUT: &str = "......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^.^.^....................................................................
.............................................................................................................................................
...................................................................^.^.^.^...................................................................
.............................................................................................................................................
..................................................................^...^...^..................................................................
.............................................................................................................................................
.................................................................^.^.....^.^.................................................................
.............................................................................................................................................
................................................................^.^.^.^.^.^.^................................................................
.............................................................................................................................................
...............................................................^.^.^.^.^.^.^.^...............................................................
.............................................................................................................................................
..............................................................^.^...^.^.^...^.^..............................................................
.............................................................................................................................................
.............................................................^...^...^...^.^...^.............................................................
.............................................................................................................................................
............................................................^...^.^.^.^.^.^...^.^............................................................
.............................................................................................................................................
...........................................................^.^.^.^.^.^.^.....^.^.^...........................................................
.............................................................................................................................................
..........................................................^.^.^.^.^...^.^.^.^.^...^..........................................................
.............................................................................................................................................
.........................................................^.^.^...^.......^.^.^.^.^.^.........................................................
.............................................................................................................................................
........................................................^.....^.^.^.^.....^.^.^.^.^.^........................................................
.............................................................................................................................................
.......................................................^.^.^.^.^.....^.^.^.^...^...^.^.......................................................
.............................................................................................................................................
......................................................^...^...^.^.^.....^.^.^...^.^...^......................................................
.............................................................................................................................................
.....................................................^.^.......^.^.^.^.^.^.^.^.^...^.^.^.....................................................
.............................................................................................................................................
....................................................^.^.^.^.^.^.^.^.^.^...^...^.^.....^.^....................................................
.............................................................................................................................................
...................................................^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^.^.^...................................................
.............................................................................................................................................
..................................................^.^.^.....^.^.^.^.^.^...^.^.^.^.^.^.^...^..................................................
.............................................................................................................................................
.................................................^...^.......^.^.^.....^...^.^...^...^.....^.................................................
.............................................................................................................................................
................................................^.^.^...^...^.....^.^...^.^.^.^.......^.^.^.^................................................
.............................................................................................................................................
...............................................^.^.^.^.^.^.^...^.^.....^.^.^.^.^.^.^...^.^.^.^...............................................
.............................................................................................................................................
..............................................^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.....^.^.^..............................................
.............................................................................................................................................
.............................................^...^.^.^...^.....^.^.^.^...^.^.^...^.^.^.^.^.^...^.............................................
.............................................................................................................................................
............................................^...^.^.^.^.^.^...^...^.^.^.^.^...^...^.^...^...^.^.^............................................
.............................................................................................................................................
...........................................^.^.^...^.^...^.^.^.^.......^.^.^...^.^.^.^.^...^.^...^...........................................
.............................................................................................................................................
..........................................^.^.^...^.^.^.^...^.^.^.^.^...^.^.^.^...^...^.^.^...^...^..........................................
.............................................................................................................................................
.........................................^.^.^.^...^.....^.^...^.^...^.^.^.^.^.^.^.^...^...^.^.....^.........................................
.............................................................................................................................................
........................................^.....^...^.......^.^.^.^.^.^...^.^.^.....^...^.^.....^.^.^.^........................................
.............................................................................................................................................
.......................................^.^.^...^.^.^.^...^.^.^...^.^...^.^.^...^.^.^.^.^.^.^.....^.^.^.......................................
.............................................................................................................................................
......................................^.^.^.....^.^.^.^.^.^.^.^.^.^.^.......^.^.^...^.....^.^...^.^...^......................................
.............................................................................................................................................
.....................................^.^...^...^.^.^...^.^.^.^.^...^.^.^.^.^.^...^.^...^...^...^.^.^.^.^.....................................
.............................................................................................................................................
....................................^.^.^.....^.^.^.^.^...^.^.^.^...^.^.^.^...^...^.^.^.^...^.^.^.^.^.^.^....................................
.............................................................................................................................................
...................................^.^.^.^.^.^.....^.^.^.^...^...^.^.....^.^.^.^.^...^...^.^.^.^.....^.^.^...................................
.............................................................................................................................................
..................................^.^...^.^.^.^.....^.^...^.^...^.^.^.........^.^.^...^.......^.^.^.......^..................................
.............................................................................................................................................
.................................^.^.^.^.^.....^.^.^.....^.......^...^.^.^.^.^...^.^...^.....^.^...^.^.^...^.................................
.............................................................................................................................................
................................^.^...^.^.....^.^.....^...^...^.^.^.^.^.^.^.^.^.....^.^.^.....^.....^.^.^...^................................
.............................................................................................................................................
...............................^...^.^.^.^.......^.^...^.^.....^.....^.^.^.^...^.....^.^.^.^.^.^.^...........^...............................
.............................................................................................................................................
..............................^.^.^.^.^.^.^.^.^.^.^.^.^...^.....^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^...^.....^...^..............................
.............................................................................................................................................
.............................^.^...^.^.^.^.^.^.^.^.^.^.^.^...^.....^.^...^...^...^...^...^.^...^...^.^...^.^...^.............................
.............................................................................................................................................
............................^.......^.^.....^...^.^...^...^.^...^.^.^.^...^.^...^.^.^.^.^...^...^...^.^.^.....^.^............................
.............................................................................................................................................
...........................^.^.^.^.^...^.^.^...^.^...^.^.^.^.^.^.^.^.^.......^.^.......^.^...^...^.^.^.^.^.^.^...^...........................
.............................................................................................................................................
..........................^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.^...^.^.^...^.......^.^.^.^.^..........................
.............................................................................................................................................
.........................^.^...^.^.^.^.^.^.^.^.....^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^...^.^...^.^.^...^.^.^.^.^.^.^.........................
.............................................................................................................................................
........................^...^.^.^...^...^...^...^.^.^.^.....^.^.^.^.^.^...^...^.^.^.^...^.^...^.^.^.^.^.^.^.^.^.^.^.^........................
.............................................................................................................................................
.......................^.^.^...^.^.......^.^...^...^...^.^.^.^.^...^.^.^.^.^.....^.^.^.^.^.^.^.^.....^.^...^.....^.^.^.......................
.............................................................................................................................................
......................^...^.^.^.....^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.......^.^.^...^...........^.....^.^.^.^.^...^.^...^......................
.............................................................................................................................................
.....................^.^.^.^.^...^.^...^.^...^...^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.......^.^.^.......^.^.^.^.^.^...^.....................
.............................................................................................................................................
....................^...^.....^.^.^.^.^.^.^.^...^.^.^.^.^...^...^.^.^.^...^.^.^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^...^...^....................
.............................................................................................................................................
...................^.....^...^.^.^.....^.....^.....^...^...^.^.^.^...^.^.^.^.^.^.^...^.....^.....^.....^.^.^.^...^.^.^...^...................
.............................................................................................................................................
..................^.^.^...^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.......^.^...^..................
.............................................................................................................................................
.................^.....^.^.^...^.^...^.^.^.....^...^...^.^.^.^.....^.^.....^.^.^.^...^.^.^.^.^.^.^...^.....^.^.^...^.^.^...^.................
.............................................................................................................................................
................^...^.^.^.^.^.^.^.^.^...^.^...^.^.^.....^...^.^...^.^.^.^.^.^.^.^.......^.^.^.^.^.^.^.^.^...^.^.^.....^.^.^.^................
.............................................................................................................................................
...............^.^.^.^.^.^.^...^.^.^.....^.^.....^.....^.^.^.....^.^.^.....^.^.^.^.^.^.....^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...............
.............................................................................................................................................
..............^...^.^...^...^.^...^.^.^.^.......^.^.^.^.^.^.^.^.^.......^.^.^.^...^.^.^.^.^...^.^.^.....^.^.^...^.^.^.^.^...^.^..............
.............................................................................................................................................
.............^.^.^.^.^...^...^.^...^.....^.....^.^.^...^.^.^...^...^...^.^.^.^.^.^...^.........^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.............
.............................................................................................................................................
............^...^.^.^.^.^...^.^.^.^...^.^.....^.^...^.^.^.^.^...^.^.^.^.^...^.....^...^.^...^...^.^.^.^.^...^.^...^.^...^.^...^.^............
.............................................................................................................................................
...........^...^.^.^.^.^.^.^.....^.^.^.^.^.......^.^.^.^.......^...^.......^...^.^.^...^.^.^...^.^...^.^.^.^.^.^...^...^.........^...........
.............................................................................................................................................
..........^...^.^.^.^.....^.^.^.^.^.^...^.......^.^.^...^.^.^.^.....^...^.^...^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^...^...^..........
.............................................................................................................................................
.........^.^.^.^.^...^...^.....^.^.^.^.^.^.^...^.^...^...^.^...^.^.^.^.^...^.^.^.^.^.^.^.^...^.^.^.^.^...^.......^.....^.^...^.^.^.^.........
.............................................................................................................................................
........^.^.^...^.^.....^...^.....^.^.^.^.^.^.^...^.^.^.^.^...^...^...^.^...^...^.....^.^.^.^.^...^...^.^.^...^...^.....^.......^...^........
.............................................................................................................................................
.......^.^.^.^.^.^.^.^.^...^.^.^...^.....^.^.^.....^.^.^.^.^.^.....^...^.^.^.^.^.^.^.^.^...^.^.^...^.^.^.^.^...^.^.^.^.^.^.......^.^.^.......
.............................................................................................................................................
......^.^.^...^...^...^.^...^...^.^.^.^.^...^.^.^.....^.^.^.^.^.^.^.^.^.^.........^.....^.^.^.^.^...^.^.^.^.^.^.^.^.^...^.^.^.^.^...^.^......
.............................................................................................................................................
.....^.^.^.^.^.^.^.^...^.^.....^...^.....^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.....^...^.^.....^.^...^.^.^.^.^.^...^.^.^.^...^...^...^.^.^.....
.............................................................................................................................................
....^.^.^.^.^.....^.^.^.^.^.....^.^.^...^...^.^.^...^.^...^.^.^.^.^.......^.^...^.^.^.^.^.^.^...^.^.^.^.^.....^.^.^.^.^...^...^...^.^.^.^....
.............................................................................................................................................
...^.^...^.^.^...^.^.^.^.^.^...^.^.......^...^.^.^.^.^...^.^.^.^.^...^...^.^.........^...^.^...^.^.^...^.^.^.....^...^...^...^.^.......^.^...
.............................................................................................................................................
..^.^.^.^.^.^.^.^...^.^.....^...^.^.^.^.^.^.^.^.^.^...^.^.^...^...^.^...^.^.^...^...^.^...^...^...^.^.^.^.............^.^.^.^.^...^.^.^.^.^..
.............................................................................................................................................
.^.^.^...^...^.....^...^...^.^.^.^...^.^.^.^.^.^.^.^.^...^.^.....^.....^.^.^.^...^.^.^.^...^...^...^.^.^.^.....^.^...^.^...^.^.^...^.....^.^.
.............................................................................................................................................";

// const INPUT: &str = ".......S.......
// ...............
// .......^.......
// ...............
// ......^.^......
// ...............
// .....^.^.^.....
// ...............
// ....^.^...^....
// ...............
// ...^.^...^.^...
// ...............
// ..^...^.....^..
// ...............
// .^.^.^.^.^...^.
// ...............";

// dfs with memoisation, returns total number of paths in subgraph
fn traverse(grid: &Vec<Vec<char>>, mem: &mut HashMap<(usize, usize), usize>, (x, y): (usize, usize)) -> usize {
    macro_rules! memoise {
        ($b: expr) => {
            if let Some(p) = mem.get(&$b) {
                *p
            } else {
                let p = traverse(grid, mem, $b);
                mem.insert($b, p);
                p
            }
        };
    }
    
    if y >= grid.len() {
        // end of grid
        return 1;
    }
    
    if grid[y][x] == '^' {
        // split beam
        // all inputs have space to split
        let b1 = (x - 1, y);
        let b2 = (x + 1, y);
        memoise!(b1) + memoise!(b2)
    } else {
        // continue downward
        let b = (x, y + 1);
        memoise!(b)
    }
}

fn main() {
    let grid: Vec<Vec<char>> = INPUT.split("\n")
        .map(|s| s.chars().collect())
        .collect();
    let start_x = grid[0].iter().enumerate().find_map(|(i, v)| (*v == 'S').then(|| i)).unwrap();
    let start_y = 1;
    
    let mut queue = VecDeque::new();
    let mut beam_pos = HashSet::new();
    beam_pos.insert((start_x, start_y));
    queue.push_back((start_x, start_y));

    // ensure that beams never overlap to avoid double counting
    let mut total_splits = 0;
    while let Some((x, y)) = queue.pop_front() {
        if y >= grid.len() {
            // end of grid
            continue;
        }
        if grid[y][x] == '^' {
            // split beam
            // all inputs have space to split
            total_splits += 1;
            let b1 = (x - 1, y);
            let b2 = (x + 1, y);
            if !beam_pos.contains(&b1) {
                queue.push_back(b1.clone());
                beam_pos.insert(b1);
            }
            if !beam_pos.contains(&b2) {
                queue.push_back(b2.clone());
                beam_pos.insert(b2);
            }
        } else {
            // continue downward
            let b = (x, y + 1);
            if !beam_pos.contains(&b) {
                queue.push_back(b.clone());
                beam_pos.insert(b);
            }
        }
    }
    
    println!("part 1: {total_splits}");
    
    let mut mem = HashMap::new();
    let total_paths = traverse(&grid, &mut mem, (start_x, start_y));
    println!("part 2: {total_paths}");
}